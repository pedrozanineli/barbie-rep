* GENERATED BY CHARMM-GUI (http://www.charmm-gui.org) v3.7 on Jun, 02. 2024. JOBID=1734830673
* SOLVATE PROTEIN IN WATER BOX
*

DIMENS CHSIZE 5000000 MAXRES 5000000 MAXGRP 5000000

! Read topology and parameter files
stream toppar.str

stream step2_molpacking.str
! Read PSF and Coordinates
open read unit 10 card name step2_molpacking.psf
read psf  unit 10 card

open read unit 10 card name step2_molpacking.crd
read coor unit 10 card

! read image psf, if it exists
if impatch .eq. YES then
    crystal free
    crystal define @XTLtype @pbcx @pbcy @pbcz @alpha @beta @gamma
    open read unit 10 card name crystal_image.str
    crystal read unit 10 card

    open read unit 10 card name cubic.img
    read imag unit 10

    print images tran
    update imall

    open read card unit 10 name image.psf
    read image psf unit 10 noautogen
    close unit 10
endif
!Reorient Solute (should be here)
!Read Water in
stream step3.1_waterbox.str

open read card unit 30 name step3.1_waterbox.crd
read coor card unit 30 append
close unit 30

!
! Add ions?
!

stream step3.4_ions.str

read psf  card name step3.4_ions.psf append
read coor card name step3.4_ions.crd append


stream polinfo/define_pbc.str
! Image non-solvents by atom, to make deleting solvent molecules easier
stream step2_molpacking.str
crystal define @xtltype @A @B @C @alpha @beta @gamma
open read unit 10 card name crystal_image.str
crystal read unit 10 card

define memb select segid MEMB end
define solvent select resname TIP3 .or. segid SV* .or. segid IONS end
set numsolv = ?nsel
define protein select .not. solvent .and. .not. memb end
set numsolvated = ?nsel

if numsolv .gt. 0 if numsolvated .gt. 0 -
    image byatoms zcen @zcen select protein end
image byresid zcen @zcen select .not. protein end

! Force image update and hide the large amount of expected output
wrnlev 1
prnlev 1
update inbfrq 0 cutim 5.0 imall
wrnlev 5
prnlev 5

set Qupdate = NO
calc nimatom = ?nati - ?nato
if nimatom .gt. 0 set Qupdate = YES

crystal free
!
! Remove water molecules close to or overlapped with
! biomolecule, crystal water, custom solvent and generated ions
!
define water select resname TIP3 .and. (segid SOLV .or. segid TIP3) end
set nwater = ?nsel
set watsegi = ?selsegi

if nwater .gt. 0 then
    define TOTO sele .not. hydrogen .and. .not. segid @watsegi end
    define target select .byres. ((type OH2 .and. segid @watsegi) -
                         .and.   (TOTO .around. 2.8)) end

    if ?nsel .gt. 0 then
        coor stat sele TOTO end
        coor stat sele target end
        delete atom sele target end
    endif

    ! PSF change requires water re-definition
    define water select resname TIP3 .and. (segid SOLV .or. segid TIP3) end
    ! also delete waters in XY periodic component regions
    set nomemb
    stream polinfo/select_pbc.str noexclude @nomemb
    define target sele .byres. (water .and. .not. hydrogen. .and. inpbc) end
    if ?nsel .gt. 0 delete atoms sele target end

    join @watsegi renumber
    coor stat sele type OH2 .and. resname TIP3 end
endif

if Qupdate .eq. YES then
    crystal define @xtltype @A @B @C @alpha @beta @gamma
    open read unit 10 card name crystal_image.str
    crystal read unit 10 card

    define water select resname TIP3 .and. (segid SOLV .or. segid TIP3) end
    image byresid zcen @zcen select segid SV* .or. water end
    image byresid zcen @zcen select segid IONS end

    wrnlev 1
    prnlev 1
    update inbfrq 0 cutim 5.0 imall
    wrnlev 5
    prnlev 5

    crystal free
    ! Re-assemble broken proteins by reading their original coordinates
    read coor card name step2_molpacking.crd
    ! Re-assemble broken polyatomic ions by reading their original coordinates
    read coor card resi name step3.4_ions.crd
endif


!
! Write coordinates and information of solvated system
!

set has_membrane = 0
define JUNK sele segid MEMB2 end
if ?nsel .gt. 0 set has_membrane = 1
if ?nsel .gt. 0 rename segid MEMB sele JUNK end

open write unit 10 card name step3_assembly.psf
write psf  unit 10 card

open write card unit 10 name step3_assembly.pdb
write coor pdb  unit 10

open write unit 10 card name step3_assembly.crd
write coor unit 10 card

open write unit 90 card name step3_assembly.str
write title unit 90
** assembly settings
**
* set has_membrane = @{has_membrane}
* set npostot = @npostot
* set nnegtot = @nnegtot
* set niontot = @niontot
*

stop
