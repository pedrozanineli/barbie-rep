* GENERATED BY CHARMM-GUI (http://www.charmm-gui.org) v3.7 on Jun, 02. 2024. JOBID=1734830673
* SETUP PERIODIC BOUNDARY CONDITION
*

DIMENS CHSIZE 5000000 MAXRES 5000000 MAXGRP 5000000

! Read topology and parameter files
stream toppar.str

! Read PSF and Coordinates
read psf  card name step3_assembly.psf



read coor card name step3_assembly.crd

! get system dimensions
stream step2_molpacking.str
stream step3_assembly.str

!
! Setup PBC (Periodic Boundary Condition)
!

stream step2_molpacking.str

! read image psf, if it exists
if impatch .eq. YES then
    crystal free
    crystal define @XTLtype @pbcx @pbcy @pbcz @alpha @beta @gamma
    open read unit 10 card name crystal_image.str
    crystal read unit 10 card

    open read unit 10 card name cubic.img
    read imag unit 10

    print images tran
    update imall

    open read card unit 10 name image.psf
    read image psf unit 10 noautogen
    close unit 10
endif
COOR CONVERT ALIGNED SYMMETRIC @A @B @C @alpha @beta @gamma

open read unit 10 card name crystal_image.str
CRYSTAL DEFINE @XTLtype @A @B @C @alpha @beta @gamma
CRYSTAL READ UNIT 10 CARD

!Image centering by residue
IMAGE BYRESID XCEN @xcen YCEN @ycen ZCEN @zcen sele resname TIP3 .or. segid SV* end
IMAGE BYRESID XCEN @xcen YCEN @ycen ZCEN @zcen sele segid IONS end

!
! Nonbonded Options
!

system "python checkfft.py ?XTLA ?XTLB ?XTLC > checkfft.str"
stream checkfft.str


nbonds atom vatom vfswitch bycb -
       ctonnb 10.0 ctofnb 12.0 cutnb 16.0 cutim 16.0 -
       inbfrq -1 imgfrq -1 wmin 1.0 cdie eps 1.0 -
       ewald pmew fftx @fftx ffty @ffty fftz @fftz  kappa .34 spline order 6
energy

!
! cons fix all heavy atoms except generated water molecules and
! short minimization
!

cons fix sele .not. ( hydrogen .or. segid SOLV .or. segid IONS ) end
cons harm force 0.1 sele segid IONS end

mini SD   nstep 50 nprint 5
mini ABNR nstep 50 nprint 5

cons fix sele none end


!
! Write coordinates and system information
!

open write unit 10 card name step4_pbcsetup.psf
write  psf unit 10 card

open write unit 10 card name step4_pbcsetup.oldpsf
write  psf unit 10 card oldpsf

open write unit 10 card name step4_pbcsetup.pdb
write coor unit 10 pdb

open write unit 10 card name step4_pbcsetup.crd
write coor unit 10 card

set has_membrane = 0
define JUNK sele segid MEMB end
if ?nsel .gt. 0 set has_membrane = 1

if @?impatch .eq. 0 set impatch = no
open  write unit 90 card name step4_pbcsetup.str
write title unit 90
* set BoxType  = @BoxType
* set XTLtype  = @XTLtype
* set A = @A
* set B = @B
* set C = @C
* set Alpha = @Alpha
* set Beta  = @Beta
* set Gamma = @Gamma
* set impatch = @impatch
* set fftx  = @fftx
* set ffty  = @ffty
* set fftz  = @fftz
* set xcen  = @xcen
* set ycen  = @ycen
* set zcen  = @zcen
* set has_membrane = @{has_membrane}
*

if impatch .eq. YES then
    system "python genimpsf_v2.py step4_pbcsetup.psf"
endif

stop
