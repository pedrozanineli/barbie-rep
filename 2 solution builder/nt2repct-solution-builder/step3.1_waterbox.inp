* GENERATED BY CHARMM-GUI (http://www.charmm-gui.org) v3.7 on Jun, 02. 2024. JOBID=1734830673
* GENERATES WATER BOX
*

DIMENS CHSIZE 5000000 MAXRES 5000000 MAXGRP 5000000

! Read topology and parameter files
stream toppar.str

stream step2_molpacking.str
calc Xinit = @A
calc Yinit = @B
calc Zinit = @C

calc xcen = 0.0
calc ycen = 0.0
calc zcen = 0.0
! parameters for water box & image (crystal) 

calc BoxSizeX = @Xinit
calc BoxSizeY = @Yinit
calc BoxSizeZ = @Zinit 

set XTLtype = ORTHorhombic
if BoxSizeX .eq. @BoxSizeY if BoxSizeX .ne. @BoxSizeZ set XTLtype = TETRagonal
if BoxSizeX .eq. @BoxSizeY if BoxSizeX .eq. @BoxSizeZ set XTLtype = CUBIc
set A = @BoxSizeX 
set B = @BoxSizeY
set C = @BoxSizeZ 
set Alpha = 90.0
set Beta  = 90.0
set Gamma = 90.0

! a pre-equilibrated water cubic box with L=18.8560
set L 18.8560

! number of boxes along XYZ-directions
calc Xnum = int(@BoxSizeX/@L) + 1
calc Ynum = int(@BoxSizeY/@L) + 1
calc Znum = int(@BoxSizeZ/@L) + 1

! base unit of water box
read sequence TIP3 216
generate W000 setup noangle nodihedral

open read unit 10 card name toppar/tip216.crd
read coor unit 10 card 
close unit 10

!
! Add or delete waters as necessary
!
coor stat select type OH2 end
set nwater = ?nsel
coor stat select type OH2 .and. resid 1 end
calc nwater = @nwater / ?nsel
set segname = ?selsegi

set target_conc = 0.032218474811576 ! molecules per cubic angstrom
calc waterbox_vol = @L ** 3 ! cubic angstroms


calc water_target = @{waterbox_vol} * @{target_conc}

! round to the nearest 1
calc rnddiff = @{water_target} % 1
set add = 0
if rnddiff .gt. 0.5 set add = 1
calc water_target = int(@{water_target}) + @add

if water_target .gt. @nwater then
    ! How many extra do we need?
    calc nshort = @{water_target} - @nwater

    ! Generate the new atoms
    read sequence TIP3 @nshort
    generate NEW setup noangle nodihedral

    ! Choose evenly-spaced resids to duplicate
    calc stride = int(@nwater / @nshort)
    if stride .eq. 0 stop   ! ABNORMAL TERMINATION, water density is too high
    label dup_water
        ! Find the old molecule by counting backwards
        calc dupid = @nwater - @stride * @nshort + 1
        define old select segid @segname .and. resid @dupid end

        ! Save its coordinates
        coor stat select old end
        calc xpos = ?xave
        calc ypos = ?yave
        calc zpos = ?zave

        calc xlen = abs(@xpos)
        calc ylen = abs(@ypos)
        calc zlen = abs(@zpos)

        ! Duplicate its coordinates onto one of the new waters
        define target select segid NEW .and. resid @nshort end
        coor duplicate select old end select target end

        !
        ! Move it 1.4 ang. toward the origin
        !

        ! Magnitude of vector to (xpos, ypos, zpos)
        calc vlen = sqrt(@xlen**2 + @ylen**2 + @zlen**2)

        ! 1.4 ang. vector pointing from old to origin
        calc xdir = -1.4 * @xpos / @vlen
        calc ydir = -1.4 * @ypos / @vlen
        calc zdir = -1.4 * @zpos / @vlen

        ! Do the move
        coor trans xdir @xdir ydir @ydir zdir @zdir select target end

        decr nshort
        if nshort .gt. 0 goto dup_water
    join @segname NEW renumber
    goto end_water
endif

label end_water
if water_target .lt. @nwater then
    ! How many extra do we have
    calc nextra = @nwater - @{water_target}

    ! Choose evenly-spaced resids to delete
    label del_water
        ! Find the target molecule by counting backwards
        calc targetid = 1 + int(?random * (@nwater - 1))

        ! Remove it
        delete atoms select segid @segname .and. resid @targetid end
        join @segname renumber

        decr nwater
        decr nextra
        if nextra .gt. 0 goto del_water
    join @segname renumber
endif


coor stat sele type OH2 end
calc Lhalf = @L / 2.0
coor trans xdir 1.0 dist @Lhalf
coor trans ydir 1.0 dist @Lhalf
coor trans zdir 1.0 dist @Lhalf
coor stat sele type OH2 end

! planar water box unit (XY)

set J2  1
label DO_2
    set J1  1
    label DO_1

    calc wsegid = ( @J2 - 1 ) * @Xnum + @J1

    read sequence TIP3 216
    generate W@wsegid setup noangle nodihedral

    coor duplicate select segid W000 end select segid W@wsegid end

    calc X = @L * ( @J1 - 1 )  ! mult X by @J1
    calc Y = @L * ( @J2 - 1 )  ! mult Y by @J2

    coor trans xdir @X ydir @Y select segid W@wsegid end

    incr J1 by 1
    if J1 le @Xnum goto DO_1
incr J2 by 1
if J2 le @Ynum goto DO_2

define junk sele .byres. ( ( type OH2 ) .and. -
                           ( prop X .gt. @BoxSizeX .or. -
                             prop Y .gt. @BoxSizeY ) ) end
if ?nsel .gt. 0 delete atoms sele junk end

define solv sele .byres. type OH2 end
if ?nsel .eq. 0 stop ! ABNORMAL TERMINATION: Too small box size 

delete atom sele segid W000 end

open write unit 10 card name water_tmp.crd
write coor unit 10 card

delete atom sele all end

! generate water box by stacking planar water boxes along Z

set J3  1
label DO_3

    open read card unit 10 name water_tmp.crd
    read sequence coor card unit 10
    generate Wz@J3 setup warn noangle nodihedral 

    open read unit 10 card name water_tmp.crd
    read coor unit 10 card append

    calc Z = @L * ( @J3 - 1 )  ! mult Y by @J3
    coor trans zdir @Z select segid Wz@J3 end

incr J3 by 1
if J3 le @Znum goto DO_3

define junk sele .byres. ( ( type OH2 ) .and. -
                           ( prop Z .gt. @BoxSizeZ ) ) end
if ?nsel .gt. 0 delete atoms sele junk end
                           
coor stat sele type OH2 end
coor orient norotation 
coor stat sele type OH2 end

!
!Shaping the box
!

COOR CONVERT ALIGNED SYMMETRIC @A @B @C @alpha @beta @gamma
coor copy comp

CRYSTAL DEFINE @XTLtype @A @B @C @alpha @beta @gamma
CRYSTAL BUILD NOPER 0 CUTOFF 2.0

!Image centering by residue
IMAGE BYRESID XCEN @xcen YCEN @ycen ZCEN @zcen

nbond ctonnb 2.0 ctofnb 3.0 cutnb 3.0 cutim 3.0 wmin 0.001
CRYSTAL FREE

stream polinfo/select_pbc.str
define pbcwat sele .byres. (inpbc .and. .not. hydrogen) end
if ?nsel gt 0 delete atoms sele pbcwat end

COOR CONVERT SYMMETRIC ALIGNED @A @B @C @alpha @beta @gamma


coor stat sele type OH2 end
set nwater ?nsel

open write unit 10 card name step3.1_waterbox.crd
write coor unit 10 card
* Equilibrated water 
*

open write card unit 2 name step3.1_waterbox.pdb
write coor pdb  unit 2 
* Equilibrated water 
*

open write unit 90 card name step3.1_waterbox.str
write title unit 90
* read sequence TIP3 @nwater
* generate SOLV setup noangle nodihedral
*

open  write unit 90 card name step3.1_waterbox.prm
write title unit 90
* set BoxType  = rect
* set XTLtype  = @XTLtype
* set A = @A
* set B = @B
* set C = @C
* set Alpha = @Alpha
* set Beta  = @Beta
* set Gamma = @Gamma
* set xcen = @xcen
* set ycen = @ycen
* set zcen = @zcen
*

stop
